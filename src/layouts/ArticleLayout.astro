---
import BaseLayout from './BaseLayout.astro';
import ReadingProgress from '../components/ReadingProgress.astro';
import BackToTop from '../components/BackToTop.astro';
import ShareButtons from '../components/ShareButtons.astro';
import TableOfContents from '../components/TableOfContents.astro';
import ArticleSchema from '../components/ArticleSchema.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import { getCategoryColorWithBg } from '../utils/categoryColors';
import type { CollectionEntry } from 'astro:content';

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  post: CollectionEntry<'blog'>;
  headings?: Heading[];
  allPosts?: CollectionEntry<'blog'>[];
}

const { post, headings = [], allPosts = [] } = Astro.props;
const { title, description, pubDate, updatedDate, tags, image } = post.data;
const articleUrl = Astro.url.href;

// Generate OG image URL for this article
const ogImageUrl = `/og/${post.slug}.png`;

// Calculate reading time (rough estimate)
const content = post.body || '';
const words = content.split(/\s+/).length;
const readingTime = Math.ceil(words / 200);

// Get next/previous posts
const sortedPosts = allPosts
  .filter(p => !p.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const currentIndex = sortedPosts.findIndex(p => p.slug === post.slug);
const prevPost = currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;

const formattedPubDate = pubDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

const formattedUpdatedDate = updatedDate?.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

const categoryColor = getCategoryColorWithBg(tags[0]);
---

<BaseLayout title={title} description={description} image={ogImageUrl}>
  <!-- JSON-LD Structured Data -->
  <ArticleSchema
    slot="head"
    title={title}
    description={description}
    pubDate={pubDate}
    updatedDate={updatedDate}
    image={ogImageUrl}
    tags={tags}
    slug={post.slug}
  />

  <!-- Reading Progress Bar with Title -->
  <ReadingProgress title={title} />

  <!-- Breadcrumbs -->
  <nav class="breadcrumbs" aria-label="Breadcrumb">
    <ol class="breadcrumb-list">
      <li class="breadcrumb-item">
        <a href="/" class="breadcrumb-link">Blog</a>
        <span class="breadcrumb-separator">/</span>
      </li>
      {tags[0] && (
        <li class="breadcrumb-item">
          <a href={`/tags/${tags[0]}`} class="breadcrumb-link breadcrumb-category">{tags[0]}</a>
          <span class="breadcrumb-separator">/</span>
        </li>
      )}
      <li class="breadcrumb-item breadcrumb-current" aria-current="page">
        <span class="breadcrumb-title">{title.length > 50 ? title.substring(0, 50) + '...' : title}</span>
      </li>
    </ol>
  </nav>

  <article class="prose prose-invert max-w-none article-wrapper" style={`--article-accent: ${categoryColor.accent}; --article-accent-bg: ${categoryColor.bg};`}>
    <!-- Hero Image (if available) -->
    {image && (
      <div class="article-hero">
        <img
          src={image}
          alt={title}
          class="article-hero-image"
          loading="eager"
          decoding="async"
        />
        <div class="article-hero-overlay"></div>
      </div>
    )}

    <!-- Article Header -->
    <header class="article-header">
      <!-- Category & Meta Row -->
      <div class="article-meta-row">
        {tags[0] && (
          <a href={`/tags/${tags[0]}`} class="article-category">
            {tags[0]}
          </a>
        )}
        <span class="article-meta-divider">/</span>
        <time datetime={pubDate.toISOString()} class="article-date">
          {formattedPubDate}
        </time>
        <span class="article-meta-divider">·</span>
        <span class="article-reading-time">{readingTime} min read</span>
        {updatedDate && (
          <>
            <span class="article-meta-divider">·</span>
            <span class="article-updated">Updated {formattedUpdatedDate}</span>
          </>
        )}
      </div>

      <!-- Title -->
      <h1 class="article-title" transition:name={`article-title-${post.slug}`}>
        {title}
      </h1>

      <!-- Description -->
      <p class="article-description">
        {description}
      </p>

      <!-- Tags & Share Row -->
      <div class="article-actions">
        {tags.length > 1 && (
          <div class="article-tags">
            {tags.slice(1).map((tag) => (
              <a href={`/tags/${tag}`} class="article-tag">
                #{tag}
              </a>
            ))}
          </div>
        )}
        <ShareButtons title={title} url={articleUrl} />
      </div>
    </header>

    <!-- Table of Contents -->
    {headings.length > 0 && (
      <TableOfContents headings={headings} />
    )}

    <!-- Article Content -->
    <div class="article-content">
      <slot />
    </div>

    <!-- Related Posts -->
    <RelatedPosts currentPost={post} allPosts={allPosts} />
  </article>

  <!-- Post Navigation -->
  <nav class="post-nav">
    {prevPost ? (
      <a href={`/blog/${prevPost.slug}`} class="post-nav-link">
        <span class="post-nav-cmd"><span class="text-[--color-accent-green]">$</span> cd ../prev</span>
        <span class="post-nav-title">{prevPost.data.title}</span>
      </a>
    ) : (
      <a href="/" class="post-nav-link">
        <span class="post-nav-cmd"><span class="text-[--color-accent-green]">$</span> cd ~/blog</span>
        <span class="post-nav-title">All Posts</span>
      </a>
    )}
    {nextPost && (
      <a href={`/blog/${nextPost.slug}`} class="post-nav-link post-nav-next">
        <span class="post-nav-cmd"><span class="text-[--color-accent-green]">$</span> cd ../next</span>
        <span class="post-nav-title">{nextPost.data.title}</span>
      </a>
    )}
  </nav>

  <!-- Back to Top Button -->
  <BackToTop />
</BaseLayout>

<!-- Copy Button Script for Code Blocks -->
<script>
  function initCodeBlocks() {
    const codeBlocks = document.querySelectorAll('.article-content pre');

    codeBlocks.forEach((pre) => {
      // Skip if already wrapped
      if (pre.parentElement?.classList.contains('code-block-wrapper')) return;

      // Create wrapper
      const wrapper = document.createElement('div');
      wrapper.className = 'code-block-wrapper';
      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);

      // Check for filename in data attributes
      const filename = pre.getAttribute('data-filename') || pre.getAttribute('data-title');

      // If filename exists, create separate filename header
      if (filename) {
        const filenameHeader = document.createElement('div');
        filenameHeader.className = 'code-filename';
        filenameHeader.textContent = filename;
        wrapper.appendChild(filenameHeader);
      }

      // Create header bar
      const header = document.createElement('div');
      header.className = 'code-block-header';

      // Add language label
      const language = pre.getAttribute('data-language');
      if (language && language !== 'plaintext') {
        const langLabel = document.createElement('span');
        langLabel.className = 'code-language-label';
        langLabel.textContent = language.toUpperCase();
        header.appendChild(langLabel);
      } else {
        // Add empty spacer to keep copy button on the right
        const spacer = document.createElement('span');
        header.appendChild(spacer);
      }

      // Create copy button
      const button = document.createElement('button');
      button.className = 'code-copy-btn';
      button.setAttribute('aria-label', 'Copy code');
      button.innerHTML = `
        <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
        <svg class="check-icon hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        <span class="copy-text">Copy</span>
      `;

      button.addEventListener('click', async () => {
        const code = pre.querySelector('code');
        const text = code?.textContent || pre.textContent || '';

        try {
          await navigator.clipboard.writeText(text);

          // Show success state
          const copyIcon = button.querySelector('.copy-icon');
          const checkIcon = button.querySelector('.check-icon');
          const copyText = button.querySelector('.copy-text');

          copyIcon?.classList.add('hidden');
          checkIcon?.classList.remove('hidden');
          if (copyText) copyText.textContent = 'Copied!';
          button.classList.add('copied');
          // Update aria-label for screen readers
          button.setAttribute('aria-label', 'Copied to clipboard');

          // Reset after 2 seconds
          setTimeout(() => {
            copyIcon?.classList.remove('hidden');
            checkIcon?.classList.add('hidden');
            if (copyText) copyText.textContent = 'Copy';
            button.classList.remove('copied');
            // Reset aria-label
            button.setAttribute('aria-label', 'Copy code');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy code:', err);
        }
      });

      // Add button to header and header to wrapper
      header.appendChild(button);
      wrapper.insertBefore(header, pre);

      // Add line numbers to each line
      const lines = pre.querySelectorAll('.line');
      lines.forEach((line, index) => {
        line.setAttribute('data-line-number', String(index + 1));
      });
    });
  }

  // Initialize on page load
  initCodeBlocks();

  // Re-initialize on Astro view transitions
  document.addEventListener('astro:after-swap', initCodeBlocks);
</script>

<!-- GitBook-style Callout Transformation Script -->
<script>
  function initCallouts() {
    const blockquotes = document.querySelectorAll('.article-content blockquote');

    // SVG icons for each callout type
    const icons: Record<string, string> = {
      danger: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
        <path d="M12 9v4"/>
        <path d="M12 17h.01"/>
      </svg>`,
      warning: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
        <path d="M12 9v4"/>
        <path d="M12 17h.01"/>
      </svg>`,
      info: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 16v-4"/>
        <path d="M12 8h.01"/>
      </svg>`,
      tip: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 2v4"/>
        <path d="m4.93 10.93 2.83 2.83"/>
        <path d="M2 18h4"/>
        <path d="M20 18h2"/>
        <path d="m19.07 10.93-2.83 2.83"/>
        <path d="M22 22H2"/>
        <path d="m8 6 4-4 4 4"/>
        <path d="M16 18a4 4 0 0 0-8 0"/>
      </svg>`,
      note: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 20h9"/>
        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
      </svg>`
    };

    // Patterns to match callout markers (case-insensitive)
    // These match textContent after markdown is parsed to HTML
    const calloutPatterns = [
      { pattern: /^U?dangerE?$/i, type: 'danger' },
      { pattern: /^U?warningE?$/i, type: 'warning' },
      { pattern: /^U?infoE?$/i, type: 'info' },
      { pattern: /^U?tipE?$/i, type: 'tip' },
      { pattern: /^U?noteE?$/i, type: 'note' },
      { pattern: /^Warning:/i, type: 'warning' },
      { pattern: /^Info:/i, type: 'info' },
      { pattern: /^Tip:/i, type: 'tip' },
      { pattern: /^Note:/i, type: 'note' },
      { pattern: /^Danger:/i, type: 'danger' }
    ];

    blockquotes.forEach((blockquote) => {
      // Skip if already transformed
      if (blockquote.classList.contains('callout')) return;

      const firstParagraph = blockquote.querySelector('p');
      if (!firstParagraph) return;

      // Check for marker in <strong> tag at the start
      const strongEl = firstParagraph.querySelector('strong:first-child');
      let calloutType = null;

      if (strongEl) {
        const strongText = strongEl.textContent?.trim() || '';
        for (const { pattern, type } of calloutPatterns) {
          if (pattern.test(strongText)) {
            calloutType = type;
            break;
          }
        }
      }

      // Also check for plain text patterns like "Warning: ..."
      if (!calloutType) {
        const textContent = firstParagraph.textContent?.trim() || '';
        for (const { pattern, type } of calloutPatterns) {
          if (pattern.test(textContent)) {
            calloutType = type;
            break;
          }
        }
      }

      if (!calloutType) return;

      // Create callout structure
      const calloutDiv = document.createElement('div');
      calloutDiv.className = `callout callout-${calloutType}`;

      // Add icon
      const iconDiv = document.createElement('div');
      iconDiv.className = 'callout-icon';
      iconDiv.innerHTML = icons[calloutType];
      calloutDiv.appendChild(iconDiv);

      // Add content
      const contentDiv = document.createElement('div');
      contentDiv.className = 'callout-content';

      // Process content - remove the marker from the first element
      const children = Array.from(blockquote.children);
      children.forEach((child, index) => {
        const clonedChild = child.cloneNode(true) as HTMLElement;
        if (index === 0) {
          // Remove the marker element or text
          const strongEl = clonedChild.querySelector('strong:first-child');
          if (strongEl && /^U?(danger|warning|info|tip|note)E?$/i.test(strongEl.textContent?.trim() || '')) {
            strongEl.remove();
          }
          // Also clean up "Warning:" style markers
          if (clonedChild.innerHTML) {
            clonedChild.innerHTML = clonedChild.innerHTML
              .replace(/^<strong>(Warning|Info|Tip|Note|Danger):<\/strong>\s*/i, '')
              .replace(/^(Warning|Info|Tip|Note|Danger):\s*/i, '')
              .trim();
          }

          // Only add if there's content left
          if (clonedChild.textContent?.trim()) {
            contentDiv.appendChild(clonedChild);
          }
        } else {
          contentDiv.appendChild(clonedChild);
        }
      });

      calloutDiv.appendChild(contentDiv);

      // Replace blockquote with callout
      blockquote.parentNode?.replaceChild(calloutDiv, blockquote);
    });
  }

  // Initialize on page load
  initCallouts();

  // Re-initialize on Astro view transitions
  document.addEventListener('astro:after-swap', initCallouts);
</script>

<!-- GitBook-style Image Lightbox Script -->
<script>
  function initImageLightbox() {
    // Get all images in article content
    const articleContent = document.querySelector('.article-content');
    if (!articleContent) return;

    const images = Array.from(articleContent.querySelectorAll('img'));
    if (images.length === 0) return;

    // Remove existing lightbox if any
    const existingLightbox = document.querySelector('.image-lightbox');
    if (existingLightbox) existingLightbox.remove();

    // Create lightbox container
    const lightbox = document.createElement('div');
    lightbox.className = 'image-lightbox';
    lightbox.setAttribute('role', 'dialog');
    lightbox.setAttribute('aria-modal', 'true');
    lightbox.setAttribute('aria-label', 'Image viewer');

    lightbox.innerHTML = `
      <button class="image-lightbox-close" aria-label="Close image viewer">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      <button class="image-lightbox-nav image-lightbox-prev" aria-label="Previous image">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
      <div class="image-lightbox-content">
        <img src="" alt="" />
        <div class="image-lightbox-caption"></div>
      </div>
      <button class="image-lightbox-nav image-lightbox-next" aria-label="Next image">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
      <div class="image-lightbox-counter"></div>
      <div class="image-lightbox-hint">ESC to close • Arrow keys to navigate</div>
    `;

    document.body.appendChild(lightbox);

    // Get lightbox elements
    const lightboxImg = lightbox.querySelector('.image-lightbox-content img') as HTMLImageElement;
    const lightboxCaption = lightbox.querySelector('.image-lightbox-caption') as HTMLDivElement;
    const lightboxCounter = lightbox.querySelector('.image-lightbox-counter') as HTMLDivElement;
    const prevBtn = lightbox.querySelector('.image-lightbox-prev') as HTMLButtonElement;
    const nextBtn = lightbox.querySelector('.image-lightbox-next') as HTMLButtonElement;
    const closeBtn = lightbox.querySelector('.image-lightbox-close') as HTMLButtonElement;

    let currentIndex = 0;
    let hasShownHint = false;

    // Get caption from image's figure/figcaption or alt text
    function getCaption(img: HTMLImageElement): string {
      const figure = img.closest('figure');
      if (figure) {
        const figcaption = figure.querySelector('figcaption');
        if (figcaption) return figcaption.textContent || '';
      }
      return img.alt || '';
    }

    // Update lightbox content
    function showImage(index: number) {
      if (index < 0 || index >= images.length) return;
      currentIndex = index;

      const img = images[index] as HTMLImageElement;
      lightboxImg.src = img.src;
      lightboxImg.alt = img.alt || '';

      const caption = getCaption(img);
      lightboxCaption.textContent = caption;
      lightboxCaption.style.display = caption ? 'block' : 'none';

      // Update counter
      lightboxCounter.textContent = `${index + 1} / ${images.length}`;

      // Update navigation buttons
      prevBtn.classList.toggle('disabled', index === 0);
      nextBtn.classList.toggle('disabled', index === images.length - 1);
    }

    // Open lightbox
    function openLightbox(index: number) {
      showImage(index);
      lightbox.classList.add('active');
      document.body.style.overflow = 'hidden';
      closeBtn.focus();

      // Item 26: Show larger keyboard hints on first open
      if (!hasShownHint) {
        const hint = lightbox.querySelector('.image-lightbox-hint') as HTMLDivElement;
        if (hint) {
          hint.classList.add('first-time');
          setTimeout(() => {
            hint.classList.remove('first-time');
          }, 3000);
        }
        hasShownHint = true;
      }
    }

    // Close lightbox
    function closeLightbox() {
      lightbox.classList.remove('active');
      document.body.style.overflow = '';
    }

    // Navigate to previous image
    function prevImage() {
      if (currentIndex > 0) {
        showImage(currentIndex - 1);
      }
    }

    // Navigate to next image
    function nextImage() {
      if (currentIndex < images.length - 1) {
        showImage(currentIndex + 1);
      }
    }

    // Add click handlers to images
    images.forEach((img, index) => {
      img.addEventListener('click', (e) => {
        e.preventDefault();
        openLightbox(index);
      });
    });

    // Close button handler
    closeBtn.addEventListener('click', closeLightbox);

    // Navigation button handlers
    prevBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      prevImage();
    });

    nextBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      nextImage();
    });

    // Click on backdrop to close
    lightbox.addEventListener('click', (e) => {
      if (e.target === lightbox) {
        closeLightbox();
      }
    });

    // Prevent clicks on content from closing
    lightbox.querySelector('.image-lightbox-content')?.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (!lightbox.classList.contains('active')) return;

      switch (e.key) {
        case 'Escape':
          closeLightbox();
          break;
        case 'ArrowLeft':
          prevImage();
          break;
        case 'ArrowRight':
          nextImage();
          break;
      }
    });

    // Focus trap for lightbox
    lightbox.addEventListener('keydown', (e) => {
      if (!lightbox.classList.contains('active')) return;
      if (e.key !== 'Tab') return;

      const focusableElements = lightbox.querySelectorAll('button:not([disabled])');
      const focusable = Array.from(focusableElements);
      const firstFocusable = focusable[0];
      const lastFocusable = focusable[focusable.length - 1];

      if (e.shiftKey && document.activeElement === firstFocusable) {
        e.preventDefault();
        lastFocusable.focus();
      } else if (!e.shiftKey && document.activeElement === lastFocusable) {
        e.preventDefault();
        firstFocusable.focus();
      }
    });
  }

  // Initialize on page load
  initImageLightbox();

  // Re-initialize on Astro view transitions
  document.addEventListener('astro:after-swap', initImageLightbox);
</script>

<style is:global>
  /* ========================================
     Breadcrumbs
     ======================================== */
  .breadcrumbs {
    max-width: 48rem;
    margin: 0 auto 1.5rem;
  }

  .breadcrumb-list {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.25rem;
    list-style: none;
    padding: 0;
    margin: 0;
    font-family: var(--font-mono);
    font-size: 0.8125rem;
  }

  .breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .breadcrumb-link {
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .breadcrumb-link:hover {
    color: var(--color-accent-cyan);
  }

  .breadcrumb-category {
    text-transform: capitalize;
  }

  .breadcrumb-separator {
    color: var(--color-border);
  }

  .breadcrumb-current {
    color: var(--color-text-secondary);
  }

  .breadcrumb-title {
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Light mode breadcrumbs */
  html.light .breadcrumb-link {
    color: var(--color-text-muted-light);
  }

  html.light .breadcrumb-link:hover {
    color: #0969da;
  }

  html.light .breadcrumb-separator {
    color: var(--color-border-light);
  }

  html.light .breadcrumb-current {
    color: var(--color-text-secondary-light);
  }

  /* ========================================
     Article Hero Image
     ======================================== */
  .article-hero {
    position: relative;
    width: 100%;
    max-width: 100%;
    margin: 0 auto 2rem;
    border-radius: 1rem;
    overflow: hidden;
    aspect-ratio: 21 / 9;
  }

  .article-hero-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .article-hero-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to bottom,
      transparent 0%,
      transparent 60%,
      rgba(13, 17, 23, 0.9) 100%
    );
    pointer-events: none;
  }

  html.light .article-hero-overlay {
    background: linear-gradient(
      to bottom,
      transparent 0%,
      transparent 60%,
      rgba(255, 255, 255, 0.95) 100%
    );
  }

  /* ========================================
     Article Header - New Design
     ======================================== */
  .article-header {
    margin-bottom: 2.5rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--color-border);
  }

  /* Meta row */
  .article-meta-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    margin-bottom: 1rem;
  }

  .article-category {
    color: var(--article-accent);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.075em;
    padding: 0.25rem 0.625rem;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid color-mix(in srgb, var(--article-accent) 30%, transparent);
    border-radius: 0.25rem;
    transition: all 0.2s ease;
  }

  .article-category:hover {
    color: var(--color-text-primary);
    background: rgba(255, 255, 255, 0.15);
    border-color: var(--article-accent);
    box-shadow: 0 0 12px color-mix(in srgb, var(--article-accent) 25%, transparent);
  }

  .article-meta-divider {
    color: var(--color-border);
  }

  .article-date,
  .article-reading-time,
  .article-updated {
    color: var(--color-text-muted);
  }

  /* Title */
  .article-title {
    font-size: 2.25rem;
    font-weight: 700;
    line-height: 1.2;
    color: var(--color-text-primary);
    margin: 0 0 1rem;
    letter-spacing: -0.02em;
  }

  @media (min-width: 768px) {
    .article-title {
      font-size: 2.75rem;
    }
  }

  /* Description */
  .article-description {
    font-size: 1.125rem;
    line-height: 1.7;
    color: var(--color-text-secondary);
    margin: 0 0 1.5rem;
    max-width: 42rem;
  }

  /* Actions row (tags + share) */
  .article-actions {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  .article-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .article-tag {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    padding: 0.25rem 0.625rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.25rem;
    transition: all 0.2s ease;
  }

  .article-tag:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: var(--article-accent);
    color: var(--article-accent);
  }

  /* Light mode header styles */
  html.light .article-header {
    border-bottom-color: var(--color-border-light);
  }

  html.light .article-meta-row {
    color: var(--color-text-muted-light);
  }

  html.light .article-category {
    background: rgba(0, 0, 0, 0.03);
    border-color: color-mix(in srgb, var(--article-accent) 20%, transparent);
  }

  html.light .article-category:hover {
    color: var(--color-text-primary-light);
    background: rgba(0, 0, 0, 0.06);
  }

  html.light .article-meta-divider {
    color: var(--color-border-light);
  }

  html.light .article-date,
  html.light .article-reading-time,
  html.light .article-updated {
    color: var(--color-text-muted-light);
  }

  html.light .article-title {
    color: var(--color-text-primary-light);
  }

  html.light .article-description {
    color: var(--color-text-secondary-light);
  }

  html.light .article-tag {
    color: var(--color-text-secondary-light);
    background: rgba(0, 0, 0, 0.03);
    border-color: rgba(0, 0, 0, 0.08);
  }

  html.light .article-tag:hover {
    background: rgba(0, 0, 0, 0.06);
  }

  /* ========================================
     Post Navigation - Terminal themed
     ======================================== */
  .post-nav {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
    max-width: 48rem;
    margin-left: auto;
    margin-right: auto;
  }

  .post-nav-link {
    display: block;
    padding: 1rem 1.25rem;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    text-decoration: none;
    transition: all 0.2s ease;
    min-width: 0;
    flex: 1;
    max-width: calc(50% - 0.5rem);
  }

  .post-nav-link:hover {
    border-color: var(--color-accent-cyan);
  }

  .post-nav-link.post-nav-next {
    text-align: right;
    margin-left: auto;
  }

  .post-nav-cmd {
    display: block;
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    margin-bottom: 0.375rem;
  }

  .post-nav-title {
    display: block;
    font-weight: 500;
    color: var(--color-text-primary);
    font-size: 0.875rem;
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .post-nav-link:hover .post-nav-title {
    color: var(--color-accent-cyan);
  }

  html.light .post-nav {
    border-color: var(--color-border-light);
  }

  html.light .post-nav-link {
    background: var(--color-bg-secondary-light);
    border-color: var(--color-border-light);
  }

  html.light .post-nav-link:hover {
    border-color: #0969da;
  }

  html.light .post-nav-cmd {
    color: var(--color-text-muted-light);
  }

  html.light .post-nav-title {
    color: var(--color-text-primary-light);
  }

  html.light .post-nav-link:hover .post-nav-title {
    color: #0969da;
  }

  /* Article wrapper - constrains content width */
  .article-wrapper {
    max-width: 48rem;
    margin-left: auto;
    margin-right: auto;
  }

  /* Article content styling */
  .article-content h2 {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--color-text-primary);
    margin-top: 2.5rem;
    margin-bottom: 1.25rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--color-border);
    letter-spacing: -0.02em;
    line-height: 1.3;
  }

  .article-content h3 {
    font-size: 1.375rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin-top: 2rem;
    margin-bottom: 1rem;
    letter-spacing: -0.01em;
    line-height: 1.4;
  }

  .article-content h4 {
    font-size: 1.125rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    line-height: 1.5;
    border-left: 3px solid var(--color-accent-cyan);
    padding-left: 0.75rem;
  }

  .article-content p {
    color: var(--color-text-secondary);
    line-height: 1.8;
    margin-bottom: 1.25rem;
    font-size: 1.0625rem;
  }

  .article-content ul,
  .article-content ol {
    color: var(--color-text-secondary);
    margin-bottom: 1rem;
    padding-left: 1.5rem;
  }

  .article-content li {
    margin-bottom: 0.5rem;
    line-height: 1.75;
  }

  .article-content ul li {
    list-style-type: disc;
  }

  .article-content ol li {
    list-style-type: decimal;
  }

  .article-content blockquote {
    position: relative;
    border-left: 4px solid var(--color-accent-cyan);
    padding-left: 2.5rem;
    margin: 1.5rem 0;
    color: var(--color-text-secondary);
    font-style: italic;
  }

  .article-content blockquote::before {
    content: '"';
    position: absolute;
    left: 0;
    top: -0.5rem;
    font-size: 3rem;
    color: var(--color-accent-cyan);
    opacity: 0.3;
    font-family: Georgia, serif;
    line-height: 1;
  }

  .article-content img {
    border-radius: 0.5rem;
    margin: 1rem auto 0.5rem;
    display: block;
    max-width: 80%;
    height: auto;
    /* CLS prevention for images with known dimensions */
    aspect-ratio: attr(width) / attr(height);
  }


  /* Style image captions/figcaptions */
  .article-content figure {
    margin: 1rem auto;
    max-width: 80%;
  }

  .article-content figure img {
    max-width: 100%;
    margin: 0 auto 0.25rem;
  }

  .article-content figcaption {
    text-align: center;
    font-size: 0.875rem;
    color: var(--color-text-muted);
    font-style: normal;
    margin: 0.25rem auto 0;
  }

  html.light .article-content figcaption {
    color: var(--color-text-muted-light);
  }

  /* Paragraphs containing only images - reduce spacing */
  .article-content p:has(> img:only-child) {
    margin-bottom: 0.25rem;
  }

  /* Full-width images for figures with "Figure X:" alt text pattern */
  /* This covers APT29, Kerberos, and other articles with numbered figures */
  .article-content figure:has(img[alt^="Figure "]) {
    max-width: 100%;
    margin: 1rem auto;
  }

  .article-content figure:has(img[alt^="Figure "]) img {
    max-width: 100%;
    width: 100%;
    margin: 0 auto;
  }

  .article-content figure:has(img[alt^="Figure "]) figcaption {
    margin-top: 0.25rem;
  }

  /* Handle direct images (not in figures) with Figure alt text */
  .article-content p:has(> img[alt^="Figure "]:only-child) {
    max-width: 100%;
    margin-bottom: 0.25rem;
  }

  .article-content img[alt^="Figure "] {
    max-width: 100%;
    width: 100%;
    margin: 0 auto;
  }

  /* Full-width images for gitbook hosted screenshots (external, not processed by Astro) */
  .article-content img[src*="gitbook"],
  .article-content figure img[src*="gitbook"] {
    max-width: 100%;
    width: 100%;
    margin: 0 auto;
  }

  .article-content figure:has(img[src*="gitbook"]) {
    max-width: 100%;
    margin: 1rem auto;
  }

  .article-content p:has(img[src*="gitbook"]) {
    max-width: 100%;
    margin-bottom: 0.25rem;
  }

  .article-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
  }

  .article-content th,
  .article-content td {
    border: 1px solid var(--color-border);
    padding: 0.75rem;
    text-align: left;
  }

  .article-content th {
    background-color: var(--color-bg-tertiary);
    font-weight: 600;
  }

  .article-content hr {
    border: none;
    border-top: 1px solid var(--color-border);
    margin: 2rem 0;
  }

  /* Light mode overrides */
  html.light .article-content h2,
  html.light .article-content h3 {
    color: var(--color-text-primary-light);
  }

  html.light .article-content h4 {
    color: var(--color-text-secondary-light);
    border-left-color: #0969da;
  }

  html.light .article-content h2 {
    border-color: var(--color-border-light);
  }

  html.light .article-content p,
  html.light .article-content ul,
  html.light .article-content ol,
  html.light .article-content blockquote {
    color: var(--color-text-secondary-light);
  }

  html.light .article-content blockquote {
    border-color: #0969da;
  }

  html.light .article-content blockquote::before {
    color: #0969da;
  }

  html.light .article-content th,
  html.light .article-content td {
    border-color: var(--color-border-light);
  }

  html.light .article-content th {
    background-color: var(--color-bg-tertiary-light);
  }

  html.light .article-content hr {
    border-color: var(--color-border-light);
  }


  html.light header {
    border-color: var(--color-border-light);
  }

  html.light h1 {
    color: var(--color-text-primary-light);
  }

  html.light header p {
    color: var(--color-text-secondary-light);
  }

  html.light a.rounded {
    background-color: var(--color-bg-tertiary-light);
    color: #1a7f37;
  }

  html.light a.rounded:hover {
    background-color: #1a7f37;
    color: white;
  }
</style>
