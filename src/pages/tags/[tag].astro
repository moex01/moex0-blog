---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleListItemWide from '../../components/ArticleListItemWide.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => data.draft !== true);

  // Get all unique tags
  const tags = [...new Set(posts.flatMap((post) => post.data.tags))];

  return tags.map((tag) => ({
    params: { tag },
    props: {
      posts: posts.filter((post) => post.data.tags.includes(tag)),
    },
  }));
}

const { tag } = Astro.params;
const { posts } = Astro.props;

// Sort posts by date (newest first)
const sortedPosts = posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

function getReadingTime(content: string): string {
  const words = content.split(/\s+/).length;
  const minutes = Math.ceil(words / 200);
  return `${minutes} min read`;
}
---

<BaseLayout title={`#${tag}`} description={`Articles tagged with #${tag}`}>
  <section>
    <header class="mb-8">
      <a
        href="/"
        class="inline-flex items-center gap-2 text-[--color-text-secondary] hover:text-[--color-accent-cyan] font-mono text-sm transition-colors mb-4"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="19" y1="12" x2="5" y2="12"></line>
          <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
        cd ../blog
      </a>

      <h1 class="text-3xl md:text-4xl font-bold text-[--color-text-primary] mb-2">
        <span class="text-[--color-accent-green] font-mono">$</span> grep -r "<span class="text-[--color-accent-indigo]">#{tag}</span>"
      </h1>
      <p class="text-[--color-text-secondary]">
        {sortedPosts.length} article{sortedPosts.length !== 1 ? 's' : ''} found
      </p>
    </header>

    <div class="articles-list">
      {sortedPosts.map((post) => (
        <ArticleListItemWide
          title={post.data.title}
          description={post.data.description}
          pubDate={post.data.pubDate}
          updatedDate={post.data.updatedDate}
          slug={post.slug}
          tags={post.data.tags}
          readingTime={getReadingTime(post.body || '')}
          image={post.data.image}
        />
      ))}
    </div>
  </section>
</BaseLayout>

<style>
  .articles-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  /* Staggered fade-in animation for article cards */
  .articles-list > :global(*) {
    opacity: 0;
    transform: translateY(12px);
    animation: fadeSlideUp 0.4s ease-out forwards;
  }

  .articles-list > :global(*:nth-child(1)) { animation-delay: 0.1s; }
  .articles-list > :global(*:nth-child(2)) { animation-delay: 0.15s; }
  .articles-list > :global(*:nth-child(3)) { animation-delay: 0.2s; }
  .articles-list > :global(*:nth-child(4)) { animation-delay: 0.25s; }
  .articles-list > :global(*:nth-child(5)) { animation-delay: 0.3s; }
  .articles-list > :global(*:nth-child(6)) { animation-delay: 0.35s; }
  .articles-list > :global(*:nth-child(7)) { animation-delay: 0.4s; }
  .articles-list > :global(*:nth-child(8)) { animation-delay: 0.45s; }
  .articles-list > :global(*:nth-child(n+9)) { animation-delay: 0.5s; }

  @keyframes fadeSlideUp {
    from {
      opacity: 0;
      transform: translateY(12px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .articles-list > :global(*) {
      opacity: 1;
      transform: none;
      animation: none;
    }
  }
</style>
