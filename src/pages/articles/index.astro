---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleListItemWide from '../../components/ArticleListItemWide.astro';
import { getCollection } from 'astro:content';

// Get all blog posts, sorted by date (newest first)
const posts = (await getCollection('blog', ({ data }) => {
  return data.draft !== true;
})).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Calculate reading time for each post
function getReadingTime(content: string): string {
  const words = content.split(/\s+/).length;
  const minutes = Math.ceil(words / 200);
  return `${minutes} min read`;
}

// Extract unique tags from all posts and get top tags
const allTags = [...new Set(posts.flatMap((post) => post.data.tags))];
// Sort tags by frequency (most used first)
const tagFrequency = allTags.map(tag => ({
  tag,
  count: posts.filter(post => post.data.tags.includes(tag)).length
})).sort((a, b) => b.count - a.count);
const topTags = tagFrequency.slice(0, 10).map(t => t.tag);
---

<BaseLayout 
  title="All Articles" 
  description="Browse all cybersecurity articles, DFIR guides, and threat intelligence research."
>
  <!-- Blog Posts -->
  <section class="articles-section">
    <div class="section-header">
      <h1 class="section-title">
        <span class="section-prompt">$</span> ls ./articles
      </h1>
      <span class="section-count">{posts.length} articles</span>
    </div>

    {posts.length === 0 ? (
      <div class="empty-state console-panel">
        <p class="empty-text">
          <span class="empty-prompt">$</span> No articles yet. Check back soon!
        </p>
      </div>
    ) : (
      <div class="articles-container">
        {/* Tag filter bar */}
        {topTags.length > 0 && (
          <div class="tag-filter-section console-panel">
            <div class="tag-filter-header">
              <span class="filter-label">
                <span class="filter-prompt">$</span> grep -i "<span class="filter-keyword">topic</span>"
              </span>
            </div>
            <div class="tag-pills">
              {topTags.map((tag) => (
                <a href={`/tags/${tag}`} class="tag-pill">
                  <span class="tag-hash">#</span>{tag}
                </a>
              ))}
            </div>
          </div>
        )}

        {/* All Articles List */}
        <div class="articles-list">
          {posts.map((post) => (
            <ArticleListItemWide
              title={post.data.title}
              description={post.data.description}
              pubDate={post.data.pubDate}
              updatedDate={post.data.updatedDate}
              slug={post.slug}
              tags={post.data.tags}
              readingTime={getReadingTime(post.body || '')}
              image={post.data.image}
            />
          ))}
        </div>
      </div>
    )}
  </section>
</BaseLayout>

<style>
  /* Articles Section */
  .articles-section {
    /* spacing handled by layout */
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--color-border);
  }

  .section-title {
    font-size: 1.5rem;
    font-weight: 600;
    font-family: var(--font-mono);
    color: var(--color-text-primary);
    margin: 0;
  }

  .section-prompt {
    color: var(--color-accent-green);
  }

  .section-count {
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    color: var(--color-text-muted);
  }

  /* Articles Container */
  .articles-container {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .articles-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  /* Tag Filter Section */
  .tag-filter-section {
    display: flex;
    flex-direction: column;
    gap: 0.875rem;
    padding: 1.25rem;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
  }

  .tag-filter-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .filter-label {
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    letter-spacing: 0.02em;
  }

  .filter-prompt {
    color: var(--color-accent-green);
    margin-right: 0.25rem;
  }

  .filter-keyword {
    color: var(--color-accent-cyan);
    font-weight: 600;
  }

  .tag-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.625rem;
  }

  .tag-pill {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 0.875rem;
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: 0.375rem;
    text-decoration: none;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
  }

  .tag-pill::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--color-accent-cyan);
    opacity: 0;
    transition: opacity 0.2s ease;
    z-index: -1;
  }

  .tag-hash {
    color: var(--color-accent-indigo);
    margin-right: 0.125rem;
    transition: color 0.2s ease;
  }

  .tag-pill:hover {
    color: var(--color-text-primary);
    border-color: var(--color-accent-cyan);
    box-shadow: 0 0 8px rgba(0, 255, 255, 0.2);
    transform: translateY(-1px);
  }

  .tag-pill:hover .tag-hash {
    color: var(--color-accent-cyan);
  }

  .tag-pill:hover::before {
    opacity: 0.08;
  }

  .tag-pill:active {
    transform: translateY(0);
    box-shadow: 0 0 4px rgba(0, 255, 255, 0.15);
  }

  /* Staggered fade-in animation for article cards */
  .articles-list > :global(*) {
    opacity: 0;
    transform: translateY(12px);
    animation: fadeSlideUp 0.4s ease-out forwards;
  }

  .articles-list > :global(*:nth-child(1)) { animation-delay: 0.05s; }
  .articles-list > :global(*:nth-child(2)) { animation-delay: 0.1s; }
  .articles-list > :global(*:nth-child(3)) { animation-delay: 0.15s; }
  .articles-list > :global(*:nth-child(4)) { animation-delay: 0.2s; }
  .articles-list > :global(*:nth-child(5)) { animation-delay: 0.25s; }
  .articles-list > :global(*:nth-child(6)) { animation-delay: 0.3s; }
  .articles-list > :global(*:nth-child(7)) { animation-delay: 0.35s; }
  .articles-list > :global(*:nth-child(8)) { animation-delay: 0.4s; }
  .articles-list > :global(*:nth-child(n+9)) { animation-delay: 0.45s; }

  @keyframes fadeSlideUp {
    from {
      opacity: 0;
      transform: translateY(12px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 3rem 1.5rem;
    border: 1px dashed var(--color-border);
    border-radius: 0.75rem;
  }

  .empty-text {
    font-family: var(--font-mono);
    color: var(--color-text-muted);
    margin: 0;
  }

  .empty-prompt {
    color: var(--color-accent-green);
  }

  /* Responsive Adjustments */
  @media (max-width: 640px) {
    .section-title {
      font-size: 1.25rem;
    }

    .tag-filter-section {
      padding: 1rem;
    }

    .filter-label {
      font-size: 0.75rem;
    }

    .tag-pill {
      padding: 0.4rem 0.75rem;
      font-size: 0.75rem;
    }
  }

  /* Reduced Motion */
  @media (prefers-reduced-motion: reduce) {
    .articles-list > :global(*) {
      opacity: 1;
      transform: none;
      animation: none;
    }

    .tag-pill:hover {
      transform: none;
    }

    .tag-pill:active {
      transform: none;
    }
  }
</style>
