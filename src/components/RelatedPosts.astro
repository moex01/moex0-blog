---
// Related Posts - Shows similar articles based on shared tags
import type { CollectionEntry } from 'astro:content';

interface Props {
  currentPost: CollectionEntry<'blog'>;
  allPosts: CollectionEntry<'blog'>[];
  maxPosts?: number;
}

const { currentPost, allPosts, maxPosts = 3 } = Astro.props;

// Calculate relatedness score based on shared tags
function getRelatednessScore(postA: CollectionEntry<'blog'>, postB: CollectionEntry<'blog'>): number {
  const tagsA = new Set(postA.data.tags || []);
  const tagsB = new Set(postB.data.tags || []);
  let score = 0;
  tagsB.forEach(tag => {
    if (tagsA.has(tag)) score++;
  });
  return score;
}

// Get related posts sorted by score, then by date
const relatedPosts = allPosts
  .filter(post => post.slug !== currentPost.slug && !post.data.draft)
  .map(post => ({
    post,
    score: getRelatednessScore(currentPost, post)
  }))
  .sort((a, b) => {
    // First sort by score (higher is better)
    if (b.score !== a.score) return b.score - a.score;
    // Then by date (newer is better)
    return b.post.data.pubDate.valueOf() - a.post.data.pubDate.valueOf();
  })
  .slice(0, maxPosts)
  .map(item => item.post);

// Format date
function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric'
  });
}
---

{relatedPosts.length > 0 && (
  <section class="related-posts">
    <h3 class="related-title">
      <span class="text-[--color-accent-green]">$</span> ls ./related
    </h3>

    <div class="related-grid">
      {relatedPosts.map(post => (
        <a href={`/blog/${post.slug}`} class="related-card">
          <span class="related-date">{formatDate(post.data.pubDate)}</span>
          <h4 class="related-post-title">{post.data.title}</h4>
          {post.data.tags && post.data.tags.length > 0 && (
            <div class="related-tags">
              {post.data.tags.slice(0, 2).map(tag => (
                <span class="related-tag">#{tag}</span>
              ))}
            </div>
          )}
        </a>
      ))}
    </div>
  </section>
)}

<style>
  .related-posts {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .related-title {
    font-family: var(--font-mono);
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: 1.5rem;
  }

  .related-grid {
    display: grid;
    gap: 1rem;
    grid-template-columns: 1fr;
  }

  @media (min-width: 640px) {
    .related-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 768px) {
    .related-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .related-card {
    display: block;
    padding: 1rem;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .related-card:hover {
    border-color: var(--color-accent-cyan);
    transform: translateY(-2px);
  }

  .related-date {
    display: block;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--color-text-muted);
    margin-bottom: 0.5rem;
  }

  .related-post-title {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--color-text-primary);
    line-height: 1.4;
    margin: 0 0 0.5rem 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .related-card:hover .related-post-title {
    color: var(--color-accent-cyan);
  }

  .related-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }

  .related-tag {
    font-family: var(--font-mono);
    font-size: 0.6875rem;
    color: var(--color-accent-green);
    background: var(--color-bg-tertiary);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
  }

</style>
