---
// Search Modal - Terminal-style search with Pagefind full-text search
import { getCollection } from 'astro:content';

// CHANGE 1: Fetch recent blog posts for empty state suggestions
const allPosts = await getCollection('blog', ({ data }) => data.draft !== true);
const sortedPosts = allPosts.sort((a, b) => 
  new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
);
const suggestedPosts = sortedPosts.slice(0, 5); // Get 5 most recent posts

const tagCounts = allPosts.reduce((acc, post) => {
  post.data.tags.forEach((tag: string) => {
    acc[tag] = (acc[tag] || 0) + 1;
  });
  return acc;
}, {} as Record<string, number>);

const topTags = Object.entries(tagCounts)
  .sort(([tagA, countA], [tagB, countB]) => {
    if (countB !== countA) return countB - countA;
    return tagA.localeCompare(tagB);
  })
  .slice(0, 8)
  .map(([tag]) => tag);
---

<div id="search-modal" class="search-modal" aria-hidden="true">
  <div class="search-backdrop"></div>
  <div class="search-container">
    <div class="search-header">
      <span class="search-prompt"><span class="text-[--color-accent-green]">$</span> search ./articles</span>
      <button class="search-close" aria-label="Close search">
        <kbd>ESC</kbd>
      </button>
    </div>
    <div class="search-input-wrapper">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
      <input
        type="text"
        id="search-input"
        class="search-input"
        placeholder="Type to search articles..."
        autocomplete="off"
      />
      <span id="search-loading" class="search-loading hidden">Searching...</span>
    </div>
    <div id="search-results" class="search-results">
      <!-- CHANGE 2: Empty state with suggestions -->
      <div id="search-empty-state" class="search-empty-state">
        <div class="search-suggestions-header">
          <span class="text-[--color-accent-cyan]">></span>
          <span class="text-[--color-text-muted]">Recent Articles</span>
        </div>
        <div class="search-suggestions">
          {suggestedPosts.map((post, index) => (
            <a 
              href={`/articles/${post.slug}`} 
              class={`search-result ${index === 0 ? 'active' : ''}`}
              data-index={index}
            >
              <div class="search-result-title">{post.data.title}</div>
              <div class="search-result-excerpt">{post.data.description}</div>
            </a>
          ))}
        </div>
        <div class="search-prompt-suggestions">
          <span class="text-[--color-text-muted]">Try searching for:</span>
          <span class="search-keywords">
            <button class="search-keyword" type="button" data-search-query="kerberos">kerberos</button>
            <button class="search-keyword" type="button" data-search-query="apt29">apt29</button>
            <button class="search-keyword" type="button" data-search-query="incident response">incident response</button>
          </span>
        </div>
        {topTags.length > 0 && (
          <div class="search-tag-group">
            <span class="search-tag-label">
              <span class="text-[--color-accent-green]">$</span> popular tags
            </span>
            <div class="search-tag-chips">
              {topTags.map((tag) => (
                <button
                  class="search-tag-chip"
                  type="button"
                  data-search-query={tag}
                >
                  <span class="tag-hash">#</span>{tag}
                </button>
              ))}
            </div>
          </div>
        )}
        <div class="search-hint">
          <span class="text-[--color-text-muted]">Press</span>
          <kbd>↑</kbd><kbd>↓</kbd>
          <span class="text-[--color-text-muted]">to navigate</span>
          <kbd>Enter</kbd>
          <span class="text-[--color-text-muted]">to select</span>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .search-modal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 200;
    align-items: flex-start;
    justify-content: center;
    padding-top: 10vh;
  }

  .search-modal[aria-hidden="false"] {
    display: flex;
  }

  .search-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
  }

  .search-container {
    position: relative;
    width: 100%;
    max-width: 600px;
    margin: 0 1rem;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 0.75rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    overflow: hidden;
  }

  .search-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--color-border);
    background: var(--color-bg-tertiary);
  }

  .search-prompt {
    font-family: var(--font-mono);
    font-size: 0.875rem;
    color: var(--color-text-primary);
  }

  .search-close {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
  }

  .search-close kbd {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    font-family: var(--font-mono);
    font-size: 0.6875rem;
    color: var(--color-text-muted);
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: 0.25rem;
  }

  .search-input-wrapper {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    border-bottom: 1px solid var(--color-border);
    color: var(--color-text-muted);
  }

  .search-input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    font-family: var(--font-mono);
    font-size: 1rem;
    color: var(--color-text-primary);
  }

  .search-input::placeholder {
    color: var(--color-text-muted);
  }

  .search-loading {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--color-accent-cyan);
  }

  .search-loading.hidden {
    display: none;
  }

  .search-results {
    max-height: 400px;
    overflow-y: auto;
    padding: 0.5rem;
  }

  .search-hint {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 1rem;
    font-family: var(--font-mono);
    font-size: 0.75rem;
  }

  .search-hint kbd {
    display: inline-block;
    padding: 0.125rem 0.375rem;
    font-family: var(--font-mono);
    font-size: 0.6875rem;
    color: var(--color-text-secondary);
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 0.25rem;
  }

  .search-result {
    display: block;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    text-decoration: none;
    transition: background-color 0.15s ease;
  }

  .search-result:hover,
  .search-result.active {
    background: var(--color-bg-tertiary);
  }

  .search-result-title {
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: 0.25rem;
  }

  .search-result.active .search-result-title {
    color: var(--color-accent-cyan);
  }

  .search-result-excerpt {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.5;
  }

  .search-result-excerpt mark {
    background: var(--color-accent-cyan);
    color: var(--color-bg-primary);
    padding: 0 2px;
    border-radius: 2px;
  }

  .search-no-results {
    text-align: center;
    padding: 2rem 1rem;
    font-family: var(--font-mono);
    color: var(--color-text-muted);
  }

  /* CHANGE 3: Empty state styling */
  .search-empty-state {
    display: block;
  }

  .search-empty-state.hidden {
    display: none;
  }

  .search-suggestions-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem 0.5rem;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .search-suggestions {
    margin-bottom: 1rem;
  }

  .search-prompt-suggestions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 1rem;
    margin: 0.5rem;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    font-family: var(--font-mono);
    font-size: 0.8125rem;
  }

  .search-keywords {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
  }

  .search-keyword {
    color: var(--color-accent-cyan);
    padding: 0.125rem 0.5rem;
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: 0.25rem;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .search-keyword:hover {
    color: var(--color-text-primary);
    border-color: var(--color-accent-cyan);
    background: rgba(56, 189, 248, 0.08);
  }

  .search-tag-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 0.75rem 1rem 0;
  }

  .search-tag-label {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .search-tag-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .search-tag-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.125rem;
    padding: 0.25rem 0.625rem;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 9999px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .search-tag-chip .tag-hash {
    color: var(--color-accent-indigo);
  }

  .search-tag-chip:hover {
    color: var(--color-accent-cyan);
    border-color: var(--color-accent-cyan);
    background: rgba(56, 189, 248, 0.08);
  }

</style>

<script is:inline>
  let pagefind = null;
  let activeIndex = 0;
  let searchTimeout = null;

  async function loadPagefind() {
    if (pagefind) return pagefind;
    try {
      // Load Pagefind dynamically at runtime
      pagefind = await import('/pagefind/pagefind.js');
      await pagefind.init();
      return pagefind;
    } catch (error) {
      console.error('Failed to load Pagefind:', error);
      return null;
    }
  }

  function openSearch() {
    const modal = document.getElementById('search-modal');
    const input = document.getElementById('search-input');
    if (modal && input) {
      modal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      loadPagefind();
      input.focus();
    }
  }

  function closeSearch() {
    const modal = document.getElementById('search-modal');
    const input = document.getElementById('search-input');
    const emptyState = document.getElementById('search-empty-state');
    if (modal && input && emptyState) {
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      input.value = '';
      // CHANGE 4: Show empty state when closing search
      emptyState.classList.remove('hidden');
      activeIndex = 0;
    }
  }

  async function search(query) {
    const results = document.getElementById('search-results');
    const loading = document.getElementById('search-loading');
    const emptyState = document.getElementById('search-empty-state');
    if (!results) return;

    // CHANGE 5: Show empty state with suggestions when query is empty
    if (!query.trim()) {
      if (emptyState) {
        emptyState.classList.remove('hidden');
      }
      activeIndex = 0;
      // Re-add active class to first suggestion
      const firstResult = document.querySelector('.search-result[data-index="0"]');
      if (firstResult) {
        document.querySelectorAll('.search-result').forEach(r => r.classList.remove('active'));
        firstResult.classList.add('active');
      }
      return;
    }

    // CHANGE 6: Hide empty state when searching
    if (emptyState) {
      emptyState.classList.add('hidden');
    }

    // CHANGE 7: Show loading state - clear results container first
    if (loading) loading.classList.remove('hidden');
    
    // Create a temporary loading container
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'search-loading-state';
    loadingDiv.innerHTML = `
      <div class="search-skeleton" style="padding: 1rem;">
        <div class="skeleton-line w-3-4"></div>
        <div class="skeleton-line w-1-2"></div>
        <div class="skeleton-line w-full"></div>
        <div class="skeleton-line w-3-4"></div>
      </div>
    `;
    results.appendChild(loadingDiv);

    const pf = await loadPagefind();
    if (!pf) {
      if (loading) loading.classList.add('hidden');
      // CHANGE 8: Clear loading state and show error
      const loadingState = results.querySelector('.search-loading-state');
      if (loadingState) loadingState.remove();
      
      const errorDiv = document.createElement('div');
      errorDiv.className = 'search-no-results';
      errorDiv.innerHTML = `
        <p>Search unavailable</p>
        <p class="text-xs mt-2">Run 'npm run build' to generate search index</p>
      `;
      results.appendChild(errorDiv);
      return;
    }

    const searchResults = await pf.search(query);
    if (loading) loading.classList.add('hidden');

    activeIndex = 0;

    // CHANGE 9: Clear loading state
    const loadingState = results.querySelector('.search-loading-state');
    if (loadingState) loadingState.remove();

    if (searchResults.results.length === 0) {
      const noResultsDiv = document.createElement('div');
      noResultsDiv.className = 'search-no-results';
      noResultsDiv.innerHTML = `
        <p>$ grep "${query}" ./articles</p>
        <p>No matches found</p>
      `;
      results.appendChild(noResultsDiv);
      return;
    }

    // Get detailed data for each result
    const detailedResults = await Promise.all(
      searchResults.results.slice(0, 10).map(async (result) => {
        const data = await result.data();
        return data;
      })
    );

    // CHANGE 10: Create results container
    const resultsContainer = document.createElement('div');
    resultsContainer.innerHTML = detailedResults.map((result, index) => `
      <a href="${result.url}" class="search-result ${index === 0 ? 'active' : ''}" data-index="${index}">
        <div class="search-result-title">${result.meta?.title || 'Untitled'}</div>
        <div class="search-result-excerpt">${result.excerpt || ''}</div>
      </a>
    `).join('');
    results.appendChild(resultsContainer);
  }

  function navigateResults(direction) {
    const results = document.querySelectorAll('.search-result');
    if (results.length === 0) return;

    if (results[activeIndex]) results[activeIndex].classList.remove('active');

    if (direction === 'down') {
      activeIndex = (activeIndex + 1) % results.length;
    } else {
      activeIndex = (activeIndex - 1 + results.length) % results.length;
    }

    if (results[activeIndex]) {
      results[activeIndex].classList.add('active');
      results[activeIndex].scrollIntoView({ block: 'nearest' });
    }
  }

  function selectResult() {
    const activeResult = document.querySelector('.search-result.active');
    if (activeResult) {
      window.location.href = activeResult.href;
    }
  }

  function initSearch() {
    // Focus trap for search modal
    const modal = document.getElementById('search-modal');
    if (modal) {
      modal.addEventListener('keydown', (e) => {
        if (modal.getAttribute('aria-hidden') === 'true') return;
        if (e.key !== 'Tab') return;

        const focusableElements = modal.querySelectorAll('button, input, a[href]');
        const focusable = Array.from(focusableElements);
        const firstFocusable = focusable[0];
        const lastFocusable = focusable[focusable.length - 1];

        if (e.shiftKey && document.activeElement === firstFocusable) {
          e.preventDefault();
          lastFocusable.focus();
        } else if (!e.shiftKey && document.activeElement === lastFocusable) {
          e.preventDefault();
          firstFocusable.focus();
        }
      });
    }

    // Keyboard shortcut (Cmd/Ctrl + K)
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        openSearch();
      }

      if (e.key === 'Escape') {
        closeSearch();
      }
    });

    // Search input with debounce
    const input = document.getElementById('search-input');
    if (input) {
      input.addEventListener('input', (e) => {
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          search(e.target.value);
        }, 150);
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          navigateResults('down');
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          navigateResults('up');
        } else if (e.key === 'Enter') {
          e.preventDefault();
          selectResult();
        }
      });
    }

    if (modal && input) {
      modal.addEventListener('click', (e) => {
        const target = e.target;
        const chip = target instanceof HTMLElement
          ? target.closest('[data-search-query]')
          : null;
        if (!chip) return;
        e.preventDefault();
        const query = chip.getAttribute('data-search-query') || '';
        if (!query) return;
        input.value = query;
        search(query);
        input.focus();
      });
    }

    // Close button
    const closeBtn = document.querySelector('.search-close');
    if (closeBtn) closeBtn.addEventListener('click', closeSearch);

    // Backdrop click
    const backdrop = document.querySelector('.search-backdrop');
    if (backdrop) backdrop.addEventListener('click', closeSearch);

    // Expose openSearch globally for the header button
    window.openSearch = openSearch;
  }

  // Initialize on page load
  initSearch();

  // Re-initialize on Astro view transitions
  document.addEventListener('astro:after-swap', initSearch);

  // Close search modal before page swap during view transitions
  document.addEventListener('astro:before-swap', closeSearch);
</script>
