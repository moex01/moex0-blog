---
const navLinks = [
  { href: '/', label: 'HOME' },
  { href: '/articles', label: 'ARTICLES' },
  { href: '/projects', label: 'MY WORK' },
  { href: '/about', label: 'ABOUT' },
];

const currentPath = Astro.url.pathname;
---

<header class="site-header sticky top-0 z-50 border-b border-[--color-border] bg-[--color-bg-primary]/80 backdrop-blur-md">
  <!-- Reading progress bar - positioned at bottom of header -->
  <div id="header-progress-bar" class="header-progress-bar"></div>

  <nav class="max-w-6xl mx-auto px-4 lg:px-8 py-4 flex items-center justify-between">
    <!-- Logo -->
    <a href="/" class="flex items-center gap-2 group">
      <span class="text-[--color-accent-green] font-mono text-xl font-bold group-hover:glow-green transition-all">
        ~/moex0
      </span>
      <span class="text-[--color-text-muted] font-mono cursor-blink">_</span>
    </a>

    <!-- Desktop Navigation -->
    <div class="hidden sm:flex items-center gap-6">
      <!-- ENHANCEMENT: Increased gap from gap-4 to gap-6 for better spacing between nav items -->
      <ul class="flex items-center gap-6">
        {navLinks.map(({ href, label }) => (
          <li>
            <a
              href={href}
              class:list={[
                'nav-link font-mono text-sm',
                currentPath === href || (href !== '/' && currentPath.startsWith(href))
                  ? 'text-[--color-accent-cyan]'
                  : 'text-[--color-text-secondary] hover:text-[--color-text-primary]'
              ]}
            >
              {label}
            </a>
          </li>
        ))}
      </ul>

      <!-- Search Button -->
      <button
        onclick="window.openSearch?.()"
        class="flex items-center gap-1.5 px-2 py-1 text-[--color-text-muted] hover:text-[--color-text-primary] bg-[--color-bg-tertiary] border border-[--color-border] rounded-md transition-colors"
        title="Search (Cmd/Ctrl+K)"
        aria-label="Search articles (Command+K)"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <span class="font-mono text-xs">âŒ˜K</span>
      </button>

      <!-- Low-Effects Toggle Button -->
      <button
        id="low-effects-toggle"
        class="text-[--color-text-secondary] hover:text-[--color-accent-cyan] transition-colors"
        title="Toggle visual effects"
        aria-label="Toggle visual effects"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 effects-icon-normal" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 effects-icon-low hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
          <line x1="1" y1="1" x2="23" y2="23"></line>
        </svg>
      </button>

      <!-- RSS Link -->
      <a
        href="/rss.xml"
        target="_blank"
        rel="noopener noreferrer"
        class="text-[--color-text-secondary] hover:text-[--color-accent-cyan] transition-colors"
        title="RSS Feed"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
          <path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1Z"/>
        </svg>
      </a>
    </div>

    <!-- Mobile: Search + Hamburger -->
    <div class="flex sm:hidden items-center gap-3">
      <!-- Mobile Search Button -->
      <button
        onclick="window.openSearch?.()"
        class="flex items-center justify-center w-9 h-9 text-[--color-text-muted] hover:text-[--color-text-primary] bg-[--color-bg-tertiary] border border-[--color-border] rounded-md transition-colors"
        title="Search"
        aria-label="Search"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </button>

      <!-- Mobile Low-Effects Toggle Button -->
      <button
        id="mobile-low-effects-toggle"
        class="flex items-center justify-center w-9 h-9 text-[--color-text-muted] hover:text-[--color-text-primary] bg-[--color-bg-tertiary] border border-[--color-border] rounded-md transition-colors"
        title="Toggle visual effects"
        aria-label="Toggle visual effects"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mobile-effects-icon-normal" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mobile-effects-icon-low hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
          <line x1="1" y1="1" x2="23" y2="23"></line>
        </svg>
      </button>

      <!-- Hamburger Button -->
      <button
        id="mobile-menu-btn"
        class="flex items-center justify-center w-9 h-9 text-[--color-text-secondary] hover:text-[--color-text-primary] transition-colors"
        aria-label="Open menu"
        aria-expanded="false"
      >
        <svg class="hamburger-icon w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
        <svg class="close-icon w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </nav>

  <!-- Mobile Menu -->
  <!-- ENHANCEMENT: Added backdrop-blur-md for better visual separation -->
  <div id="mobile-menu" class="mobile-menu hidden sm:hidden">
    <ul class="mobile-nav-links">
      {navLinks.map(({ href, label }, index) => (
        <li>
          <a
            href={href}
            class:list={[
              'mobile-nav-link',
              (currentPath === href || (href !== '/' && currentPath.startsWith(href))) && 'active'
            ]}
          >
            <!-- ENHANCEMENT: Added chevron icon for better visual recognition -->
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mobile-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
            <span>{label}</span>
          </a>
          <!-- ENHANCEMENT: Added subtle dividers between menu items (not after last item) -->
          {index < navLinks.length - 1 && (
            <div class="mobile-nav-divider"></div>
          )}
        </li>
      ))}
    </ul>
    <div class="mobile-menu-actions">
      <a
        href="/rss.xml"
        target="_blank"
        rel="noopener noreferrer"
        class="mobile-action-link"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
          <path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1Z"/>
        </svg>
        <span>RSS Feed</span>
      </a>
    </div>
  </div>
</header>

<script>
  // === LOW-EFFECTS TOGGLE FUNCTIONALITY ===
  function initLowEffectsToggle() {
    const desktopToggle = document.getElementById('low-effects-toggle');
    const mobileToggle = document.getElementById('mobile-low-effects-toggle');
    
    // Initialize state from localStorage or prefers-reduced-motion
    function getInitialState(): boolean {
      // Check localStorage first
      const stored = localStorage.getItem('lowEffects');
      if (stored !== null) {
        return stored === 'true';
      }
      
      // Fall back to prefers-reduced-motion
      return window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    }

    // Apply low-effects state to document
    function applyLowEffects(enabled: boolean) {
      if (enabled) {
        document.documentElement.classList.add('low-effects');
      } else {
        document.documentElement.classList.remove('low-effects');
      }
      
      // Update icon states for both desktop and mobile
      updateIcons(enabled);
      
      // Store preference
      localStorage.setItem('lowEffects', enabled.toString());
      
      // Dispatch custom event for MatrixRain to listen to
      window.dispatchEvent(new CustomEvent('low-effects-change', { detail: { enabled } }));
    }

    // Update icon visibility
    function updateIcons(lowEffectsEnabled: boolean) {
      // Desktop icons
      const normalIcon = desktopToggle?.querySelector('.effects-icon-normal');
      const lowIcon = desktopToggle?.querySelector('.effects-icon-low');
      
      // Mobile icons
      const mobileNormalIcon = mobileToggle?.querySelector('.mobile-effects-icon-normal');
      const mobileLowIcon = mobileToggle?.querySelector('.mobile-effects-icon-low');
      
      if (lowEffectsEnabled) {
        normalIcon?.classList.add('hidden');
        lowIcon?.classList.remove('hidden');
        mobileNormalIcon?.classList.add('hidden');
        mobileLowIcon?.classList.remove('hidden');
      } else {
        normalIcon?.classList.remove('hidden');
        lowIcon?.classList.add('hidden');
        mobileNormalIcon?.classList.remove('hidden');
        mobileLowIcon?.classList.add('hidden');
      }
    }

    // Toggle handler
    function toggleLowEffects() {
      const currentState = document.documentElement.classList.contains('low-effects');
      applyLowEffects(!currentState);
    }

    // Attach event listeners
    desktopToggle?.addEventListener('click', toggleLowEffects);
    mobileToggle?.addEventListener('click', toggleLowEffects);

    // Initialize on page load
    const initialState = getInitialState();
    applyLowEffects(initialState);
  }

  // === MOBILE MENU FUNCTIONALITY ===
  function initMobileMenu() {
    const menuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const hamburgerIcon = menuBtn?.querySelector('.hamburger-icon');
    const closeIcon = menuBtn?.querySelector('.close-icon');

    if (!menuBtn || !mobileMenu) return;

    menuBtn.addEventListener('click', () => {
      const isOpen = !mobileMenu.classList.contains('hidden');

      if (isOpen) {
        mobileMenu.classList.add('hidden');
        hamburgerIcon?.classList.remove('hidden');
        closeIcon?.classList.add('hidden');
        menuBtn.setAttribute('aria-expanded', 'false');
        menuBtn.setAttribute('aria-label', 'Open menu');
      } else {
        mobileMenu.classList.remove('hidden');
        hamburgerIcon?.classList.add('hidden');
        closeIcon?.classList.remove('hidden');
        menuBtn.setAttribute('aria-expanded', 'true');
        menuBtn.setAttribute('aria-label', 'Close menu');
      }
    });

    // Close menu when clicking a link
    mobileMenu.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        mobileMenu.classList.add('hidden');
        hamburgerIcon?.classList.remove('hidden');
        closeIcon?.classList.add('hidden');
        menuBtn.setAttribute('aria-expanded', 'false');
        menuBtn.setAttribute('aria-label', 'Open menu');
      });
    });

    // Escape key handling for mobile menu
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !mobileMenu.classList.contains('hidden')) {
        mobileMenu.classList.add('hidden');
        hamburgerIcon?.classList.remove('hidden');
        closeIcon?.classList.add('hidden');
        menuBtn.setAttribute('aria-expanded', 'false');
        menuBtn.setAttribute('aria-label', 'Open menu');
      }
    });
  }

  // Initialize both features
  initLowEffectsToggle();
  initMobileMenu();
  
  // Re-initialize on Astro page transitions
  document.addEventListener('astro:after-swap', () => {
    initLowEffectsToggle();
    initMobileMenu();
  });
</script>

<style>
  .site-header {
    border-bottom-color: transparent;
    background-image: linear-gradient(
      to bottom,
      transparent calc(100% - 1px),
      color-mix(in srgb, var(--color-border) 60%, transparent) calc(100% - 1px),
      color-mix(in srgb, var(--color-border) 60%, transparent) 100%
    );
  }

  /* Item 17: Progress bar with shimmer gradient animation */
  .header-progress-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    width: 0%;
    background: linear-gradient(
      90deg,
      var(--color-accent-cyan),
      var(--color-accent-green),
      var(--color-accent-cyan)
    );
    background-size: 200% 100%;
    animation: progress-shimmer 3s ease infinite;
    transition: width 0.15s ease-out;
    pointer-events: none;
  }

  /* Item 5: Subtle hover effect for navigation links */
  /* ENHANCEMENT: Added underline-on-hover with smooth transition */
  .nav-link {
    display: inline-block;
    position: relative;
    transition: color 0.2s ease, transform 0.2s ease;
  }

  /* ENHANCEMENT: Subtle underline that appears on hover */
  .nav-link::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 0;
    width: 0%;
    height: 1px;
    background: var(--color-accent-cyan);
    transition: width 0.3s ease;
  }

  .nav-link:hover {
    transform: translateY(-1px);
  }

  /* ENHANCEMENT: Underline expands on hover */
  .nav-link:hover::after {
    width: 100%;
  }

  /* Item 15: Mobile Menu with slide-down animation */
  /* ENHANCEMENT: Strengthened background with darker shade and backdrop-blur for better contrast */
  .mobile-menu {
    padding: 1rem;
    border-top: 1px solid var(--color-border);
    background: rgba(13, 17, 23, 0.95); /* Darker background with slight transparency */
    backdrop-filter: blur(12px); /* Blur effect for better visual separation */
    -webkit-backdrop-filter: blur(12px); /* Safari support */
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
  }

  .mobile-menu:not(.hidden) {
    max-height: 400px;
    opacity: 1;
  }

  .mobile-nav-links {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    list-style: none;
    padding: 0;
    margin: 0 0 1rem 0;
  }

  /* ENHANCEMENT: Mobile nav links now display with icon in a flex layout */
  .mobile-nav-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    font-family: var(--font-mono);
    font-size: 0.9375rem;
    color: var(--color-text-secondary);
    text-decoration: none;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
  }

  /* ENHANCEMENT: Icon styling for mobile nav */
  .mobile-nav-icon {
    flex-shrink: 0;
    opacity: 0.6;
    transition: opacity 0.2s ease, transform 0.2s ease;
  }

  /* ENHANCEMENT: Icon animates forward on hover */
  .mobile-nav-link:hover {
    background: var(--color-bg-tertiary);
    color: var(--color-text-primary);
  }

  .mobile-nav-link:hover .mobile-nav-icon {
    opacity: 1;
    transform: translateX(2px);
  }

  .mobile-nav-link.active {
    color: var(--color-accent-cyan);
    background: rgba(56, 189, 248, 0.1);
  }

  .mobile-nav-link.active .mobile-nav-icon {
    opacity: 1;
  }

  .mobile-menu-actions {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border);
  }

  .mobile-action-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: var(--font-mono);
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .mobile-action-link:hover {
    color: var(--color-accent-cyan);
  }

  /* ENHANCEMENT: Subtle dividers between mobile nav items */
  .mobile-nav-divider {
    height: 1px;
    margin: 0.25rem 1rem;
    background: linear-gradient(
      90deg,
      transparent,
      var(--color-border) 20%,
      var(--color-border) 80%,
      transparent
    );
    opacity: 0.5;
  }

</style>
